<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Balance - Royal Crumbs</title>
  <link rel="stylesheet" href="{{ url_for('static', path='css/account-cartera-balance.css') }}">
</head>

<body>

  <div class="rc-container">
    <!-- ENCABEZADO -->
    <div class="rc-header">
      <a href="/account/cartera" class="rc-back">‚Äπ</a>
      <h1 class="rc-screen-title">Balance</h1>
    </div>

    <!-- SECCI√ìN SUPERIOR -->
    <section class="balance-top">
      <h2 class="rc-subtitle">Saldo Total</h2>
      <p class="saldo-total">Cargando...</p>

      <div class="btn-row">
        <button class="btn-dorado">Depositar</button>
        <button class="btn-dorado">Retirar</button>
      </div>
    </section>

    <!-- DISTRIBUCI√ìN RESPONSIVA -->
    <div class="balance-layout">

      <!-- IZQUIERDA: PR√âSTAMO -->
      <section class="prestamo-section">
        <h2 class="rc-subtitle">Pr√©stamo</h2>

        <input type="text" class="input-field" placeholder="Introduce un monto">
        <select class="input-field">
          <option>Seleccionar Garant√≠a</option>
          <option>Saldo Principal</option>
          <option>Bonificaci√≥n</option>
        </select>
        <button class="btn-dorado">Solicitar</button>

        <div class="balance-box">
          <h3>Adeudos</h3>
          <p><strong>Vencimiento:</strong> 30 de Noviembre</p>
          <p>Pr√©stamo de Juego <span class="negativo">- $150.00</span></p>
        </div>
      </section>

      <!-- DERECHA: INFORMACI√ìN DE BALANCE -->
      <section class="right-column">

        <div class="balance-box">
          <h3>Detalle del Saldo</h3>
          <div class="detail-row">
            <span>Saldo Principal</span>
            <span class="saldo-principal">Cargando...</span>
          </div>
          <div class="detail-row">
            <span>Saldo de Bonificaci√≥n</span>
            <span>$0.00</span>
          </div>
        </div>

        <div class="balance-box">
          <h3>Adeudos</h3>
          <p><strong>Vencimiento:</strong> 30 de Noviembre</p>
          <p>Pr√©stamo de Juego <span class="negativo">- $150.00</span></p>
        </div>

        <div class="balance-box">
          <h3>L√≠mite</h3>
          <input type="range" min="10" max="5000" value="2500" class="limite-slider">
          <div class="limite-etiquetas">
            <span>$10.00</span>
            <span>$1000.00</span>
          </div>

          <div class="btn-row">
            <button class="btn-gris">Cambiar L√≠mite</button>
            <button class="btn-dorado">Pr√©stamo</button>
          </div>
        </div>
      </section>

    </div> <!-- balance-layout -->

  </div>

  <!-- NAV INFERIOR -->
  <nav class="rc-nav">
    <a href="/home" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/home_icon.png') }}" alt="Inicio">
      <span>Inicio</span>
    </a>
    <a href="/games" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/games_icon.png') }}" alt="Juegos">
      <span>Juegos</span>
    </a>
    <a href="/support" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/support_icon.png') }}" alt="Soporte">
      <span>Soporte</span>
    </a>
    <a href="/account/cartera" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/wallet_icon.png') }}" alt="Cartera">
      <span>Cartera</span>
    </a>
  </nav>

  <!-- SCRIPT PARA CARGAR SALDO DIN√ÅMICAMENTE -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // MIGRACI√ìN AUTOM√ÅTICA: Si existe el formato antiguo, migrar al nuevo
      if (localStorage.getItem("userId") && !localStorage.getItem("user_id")) {
        console.log("‚úÖ Migrando localStorage de userId ‚Üí user_id");
        localStorage.setItem("user_id", localStorage.getItem("userId"));
        localStorage.setItem("id_rol", localStorage.getItem("idRol"));
        localStorage.setItem("user_role", localStorage.getItem("userRole"));
        localStorage.removeItem("userId");
        localStorage.removeItem("idRol");
        localStorage.removeItem("userRole");
      }

      const userId = localStorage.getItem("user_id");

      console.log("üìç User ID:", userId);

      if (!userId) {
        alert("No se ha iniciado sesi√≥n. Redirigiendo al login.");
        window.location.href = "/login";
        return;
      }

      try {
        console.log("üîÑ Llamando API:", `/api/user/${userId}`);

        const response = await fetch(`/api/user/${userId}`);

        console.log("üì° Status:", response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error("‚ùå Error:", errorText);
          throw new Error("Error al cargar datos");
        }

        const data = await response.json();
        console.log("‚úÖ Datos recibidos:", data);

        // Formatear saldo
        const formattedBalance = new Intl.NumberFormat('es-MX', {
          style: 'currency',
          currency: 'MXN'
        }).format(data.saldo || 0);

        console.log("üí∞ Saldo formateado:", formattedBalance);

        // Actualizar elementos
        const saldoTotal = document.querySelector(".saldo-total");
        const saldoPrincipal = document.querySelector(".saldo-principal");

        if (saldoTotal) saldoTotal.textContent = formattedBalance;
        if (saldoPrincipal) saldoPrincipal.textContent = formattedBalance;

      } catch (error) {
        console.error("‚ùå Error completo:", error);
        const saldoTotal = document.querySelector(".saldo-total");
        if (saldoTotal) saldoTotal.textContent = "Error al cargar";
        alert("Error: " + error.message + "\n\nRevisa la consola (F12) para m√°s detalles.");
      }
    });
  </script>

</body>

</html>