<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarjeta - Royal Crumbs</title>
  <link rel="stylesheet" href="{{ url_for('static', path='css/account-tarjeta.css') }}">
</head>

<body>

  <div class="rc-container">
    <!-- ENCABEZADO -->
    <div class="rc-header">
      <a href="/account/metodos" class="rc-back">‹</a>
      <h1 class="rc-screen-title">Mi cuenta</h1>
    </div>

    <!-- TÍTULO -->
    <h2 class="rc-section-title">Tarjeta de Crédito/Débito</h2>
    <p style="color: #aaa; text-align: center; font-size: 0.9em; margin-top: -10px; margin-bottom: 20px;">
      Guarda tu tarjeta para futuros depósitos.
    </p>

    <!-- 
      FORMULARIO CORREGIDO
      - Añadido id="cardForm"
      - Añadidos 'name' a los inputs
      - ELIMINADO el campo "Monto del Depósito"
    -->
    <form class="card-form" id="cardForm">
      <input type="text" name="numero_tarjeta" placeholder="Número de Tarjeta (16 dígitos)" required>
      <input type="text" name="nombre_titular" placeholder="Nombre del Titular" required>

      <div class="card-row">
        <input type="text" name="fecha_exp" placeholder="MM/AA" required>
        <input type="text" name="cvv" placeholder="CVV (No se guardará)" required>
      </div>

      <button type="submit" class="btn-save">Guardar Tarjeta</button>
      <button type="button" class="btn-delete">Eliminar</button>
    </form>
  </div>

  <!-- BARRA INFERIOR -->
  <nav class="rc-nav">
    [Immersive content redacted for brevity.]
  </nav>

  <!-- 
    ==================================================
    SCRIPT DE CONEXIÓN (¡Añadido!)
    ==================================================
  -->
  <script>
    // 1. Verificar sesión
    const userId = localStorage.getItem("user_id");
    if (!userId) {
      alert("No has iniciado sesión.");
      window.location.href = "/login";
    }

    // 2. Capturar el formulario
    const cardForm = document.getElementById("cardForm");

    cardForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(cardForm);
      formData.append("id_usuario", userId);

      const numero = formData.get("numero_tarjeta");
      if (numero.length < 15 || numero.length > 16 || !/^\d+$/.test(numero)) {
        alert("El número de tarjeta debe tener 15 o 16 dígitos.");
        return;
      }

      try {
        // 3. Llamar a la NUEVA ruta de API
        const res = await fetch("/api/wallet/save-method-card", {
          method: "POST",
          body: formData
        });

        const result = await res.json();

        if (result.error) {
          alert("Error: " + result.error);
        } else if (result.success) {
          alert("¡Tarjeta guardada con éxito!");
          window.location.href = "/account/metodos";
        }

      } catch (error) {
        console.error("Error al guardar:", error);
        alert("Error de conexión al guardar la tarjeta.");
      }
    });
  </script>

</body>

</html>