<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Cuenta - Configuración</title>
  <link rel="stylesheet" href="{{ url_for('static', path='css/account-configuracion.css') }}">
</head>
<body>

  <div class="rc-container">
    <!-- ENCABEZADO -->
    <div class="rc-header">
      <a href="/account" class="rc-back">‹</a>
      <h1 class="rc-screen-title">Mi cuenta</h1>
    </div>

    <!-- SUBTÍTULO -->
    <div class="rc-subtitle">Configuracion</div>

    <!-- SECCIÓN IMAGEN (sin cambios) -->
    <div class="profile-upload">
      <label for="file-input" class="upload-box">
        <img id="preview" src="{{ url_for('static', path='img/imagen-cuenta.png') }}" alt="Subir imagen">
      </label>
      <input id="file-input" type="file" accept="image/*" onchange="previewImage(event)">
    </div>

    <!-- 
      FORMULARIO
      - Añadido 'id' al formulario
      - Añadidos 'id' y 'name' a los inputs
    -->
    <form class="rc-form" id="configForm">
      <input type="text" id="nombre" name="nombre" placeholder="Nombre(s)">
      <input type="text" id="apellido" name="apellido" placeholder="Apellido(s)">
      <input type="email" id="email" name="email" placeholder="Correo">
      
      <input type="password" id="password" name="password" placeholder="Nueva Contraseña (dejar en blanco para no cambiar)">
      
      <!--
      <input type="text" placeholder="Usuario"> (Tu BD no tiene 'usuario' (username), solo nombre/apellido)
      <input type="text" placeholder="Comentario(opcional)"> (Tu BD no tiene 'comentario')
      -->

      <button type="submit" class="btn-save">Guardar Cambios</button>
      <button type="button" class="btn-delete" id="btnEliminar">Eliminar Cuenta</button>
    </form>
  </div>

  <!-- BARRA INFERIOR (sin cambios) -->
  <nav class="rc-nav">
    <a href="/home" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/home_icon.png') }}" alt="Inicio">
      <span>Inicio</span>
    </a>
    <a href="/games" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/games_icon.png') }}" alt="Juegos">
      <span>Juegos</span>
    </a>
    <a href="/support" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/support_icon.png') }}" alt="Soporte">
      <span>Soporte</span>
    </a>
    <a href="/account/cartera" class="rc-nav-item">
      <img src="{{ url_for('static', path='img/wallet_icon.png') }}" alt="Cartera">
      <span>Cartera</span>
    </a>
  </nav>

  <!-- 
    ==================================================
    SCRIPT DE CONEXIÓN (¡Añadido!)
    ==================================================
  -->
  <script>
    // PREVISUALIZAR IMAGEN (Tu código)
    function previewImage(event) {
      const input = event.target;
      const reader = new FileReader();
      reader.onload = function(){
        const preview = document.getElementById('preview');
        preview.src = reader.result;
      };
      if (input.files[0]) {
        reader.readAsDataURL(input.files[0]);
      }
    }

    // 1. Verificar sesión
    const userId = localStorage.getItem("usuario_id");
    if (!userId) {
      alert("No has iniciado sesión.");
      window.location.href = "/login";
    }

    const configForm = document.getElementById("configForm");

    // 2. FUNCIÓN PARA CARGAR DATOS (GET)
    // Se ejecuta apenas carga la página
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch(`/api/user/${userId}`);
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        // Rellenar el formulario con los datos de la BD
        document.getElementById("nombre").value = data.nombre || "";
        document.getElementById("apellido").value = data.apellido || "";
        document.getElementById("email").value = data.email || "";

      } catch (error) {
        console.error("Error al cargar datos:", error);
        alert("No se pudo cargar la información del perfil.");
      }
    });

    // 3. FUNCIÓN PARA GUARDAR DATOS (PUT)
    // Se ejecuta al presionar "Guardar Cambios"
    configForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(configForm);

      // (Nota: Tu API ignora el campo 'password' por ahora, 
      //  pero si quisieras implementarlo, lo leerías aquí)

      try {
        const res = await fetch(`/api/user/update/${userId}`, {
          method: "PUT",
          body: formData
        });

        const result = await res.json();

        if (result.error) {
          alert("Error al guardar: " + result.error);
        } else if (result.success) {
          alert("¡Perfil actualizado con éxito!");
        }

      } catch (error) {
        console.error("Error al guardar:", error);
        alert("Error de conexión al guardar el perfil.");
      }
    });

    // 4. FUNCIÓN PARA ELIMINAR CUENTA (Opcional)
    // (Aún no hemos creado esta API, pero el botón está listo)
    document.getElementById("btnEliminar").addEventListener("click", () => {
      if (confirm("¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.")) {
        // Aquí iría el fetch a la ruta:
        // fetch(`/api/user/delete/${userId}`, { method: "DELETE" })
        alert("Función de eliminar aún no implementada.");
      }
    });

  </script>

</body>
</html>
