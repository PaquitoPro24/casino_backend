<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar Sesi√≥n - Royal Crumbs</title>
  <link rel="manifest" href="/manifest.json?v=2">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Timeless', 'Georgia', 'Times New Roman', serif;
      background-color: #202020;
      color: #FFFFFF;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Contenedor principal */
    .login-container {
      width: 100%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    /* Logo - Especificaciones de Figma: 102x96px */
    .logo {
      width: 102px;
      height: 96px;
      object-fit: contain;
      margin-bottom: 40px;
    }

    /* T√≠tulo "Iniciar Sesi√≥n" - Especificaciones de Figma */
    .title {
      font-family: 'Timeless', 'Georgia', 'Times New Roman', serif;
      font-size: 32px;
      font-weight: 700;
      font-style: normal;
      line-height: normal;
      color: #FFFFFF;
      margin-bottom: 40px;
      width: 206px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Formulario */
    .login-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    /* Campos de entrada - Especificaciones de Figma: 315x36px */
    .input-field {
      width: 315px;
      height: 36px;
      border-radius: 8px;
      background: #FFFFFF;
      border: none;
      padding: 0 12px;
      font-family: 'Timeless', 'Georgia', 'Times New Roman', serif;
      font-size: 14px;
      color: #2D2D2D;
    }

    .input-field::placeholder {
      color: #999999;
    }

    .input-field:focus {
      outline: 2px solid #AB925C;
    }

    /* Link "¬øOlvidaste tu Contrase√±a?" - Especificaciones de Figma */
    .forgot-password {
      font-family: 'Timeless', 'Georgia', 'Times New Roman', serif;
      font-size: 13px;
      font-weight: 700;
      color: #FFFFFF;
      text-decoration: underline;
      text-decoration-style: solid;
      text-decoration-skip-ink: auto;
      text-underline-offset: auto;
      text-underline-position: from-font;
      margin-top: 8px;
      margin-bottom: 24px;
      cursor: pointer;
      align-self: flex-start;
      margin-left: calc((100% - 315px) / 2);
    }

    .forgot-password:hover {
      color: #AB925C;
    }

    /* Bot√≥n "Iniciar Sesi√≥n" */
    .btn-login {
      width: 285px;
      height: 44px;
      border-radius: 8px;
      background: #AB925C;
      border: none;
      font-family: 'Timeless', 'Georgia', 'Times New Roman', serif;
      font-size: 20px;
      font-weight: 700;
      color: #FFFFFF;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 16px;
    }

    .btn-login:hover {
      background: #967F4A;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(171, 146, 92, 0.3);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    /* Link "¬øNo tienes una cuenta? Reg√≠strate" */
    .register-link {
      font-family: 'Timeless', 'Georgia', 'Times New Roman', serif;
      font-size: 13px;
      font-weight: 700;
      color: #FFFFFF;
      text-decoration: underline;
      margin-top: 40px;
      cursor: pointer;
    }

    .register-link:hover {
      color: #AB925C;
    }

    /* Mensaje de error */
    .error-message {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid #FF3B30;
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      color: #FF3B30;
      font-size: 14px;
      width: 315px;
      text-align: center;
    }

    /* Responsive para pantallas peque√±as */
    @media (max-width: 360px) {

      .input-field,
      .error-message {
        width: 100%;
        max-width: 315px;
      }

      .btn-login {
        width: 100%;
        max-width: 285px;
      }

      .forgot-password {
        margin-left: 0;
      }
    }

    /* Responsive para pantallas grandes */
    @media (min-width: 768px) {
      .logo {
        width: 120px;
        height: auto;
        margin-bottom: 50px;
      }

      .title {
        font-size: 36px;
        width: auto;
        height: auto;
        margin-bottom: 50px;
      }
    }
  </style>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register("/sw.js", { scope: '/' })
          .then(function (registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);

            // Check for updates
            registration.onupdatefound = () => {
              const installingWorker = registration.installing;
              installingWorker.onstatechange = () => {
                if (installingWorker.state === 'installed') {
                  if (navigator.serviceWorker.controller) {
                    console.log('New content is available; please refresh.');
                  } else {
                    console.log('Content is cached for offline use.');
                  }
                }
              };
            };
          }, function (err) {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</head>

<body>
  <div class="login-container">
    <img src="{{ url_for('static', path='img/logo.png') }}" alt="Royal Crumbs Logo" class="logo">
    <h1 class="title">Iniciar Sesi√≥n</h1>

    <form id="login-form" class="login-form">
      <input type="email" id="email" name="email" class="input-field" placeholder="Usuario o Correo Electr√≥nico"
        required>
      <input type="password" id="password" name="password" class="input-field" placeholder="Contrase√±a" required>

      <a href="/forgot-password" class="forgot-password">¬øOlvidaste tu Contrase√±a?</a>

      <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
    </form>

    <div id="error-message" class="error-message" style="display: none;"></div>

    <a href="/register" class="register-link">¬øNo tienes una cuenta? Reg√≠strate</a>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loginForm = document.getElementById("login-form");
      const errorMessageDiv = document.getElementById("error-message");

      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(loginForm);
        const data = Object.fromEntries(formData.entries());
        data.correo = data.email;
        data.contrasena = data.password;
        delete data.email;
        delete data.password;

        errorMessageDiv.style.display = "none";

        try {
          const response = await fetch("/api/auth/login", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Error desconocido al iniciar sesi√≥n.");
          }

          // Guardar datos en localStorage con nombres consistentes (viejos y nuevos)
          localStorage.setItem("user_id", result.id_usuario);   // usado por home, soporte, etc.
          localStorage.setItem("userId", result.id_usuario);    // usado por vistas de agente

          localStorage.setItem("id_rol", result.id_rol);        // nombre viejo
          localStorage.setItem("idRol", result.id_rol);         // por si alguna vista usa camelCase

          localStorage.setItem("user_role", result.rol);        // nombre viejo
          localStorage.setItem("userRole", result.rol);         // nombre nuevo/camelCase

          // Debugging - verificar qu√© est√° llegando
          console.log("üîç Datos de login recibidos:", result);
          console.log("üîç id_rol:", result.id_rol, "tipo:", typeof result.id_rol);
          console.log("üîç rol:", result.rol);

          // Redirigir seg√∫n el id_rol del usuario
          if (result.id_rol == 1) {
            console.log("‚úÖ Redirigiendo a /home (Jugador)");
            window.location.href = "/home";
          } else if (result.id_rol == 2) {
            console.log("‚úÖ Redirigiendo a /admin (Administrador)");
            window.location.href = "/admin";
          } else if (result.id_rol == 3) {
            console.log("‚úÖ Redirigiendo a /auditor (Auditor)");
            window.location.href = "/auditor";
          } else if (result.id_rol == 4) {
            console.log("‚úÖ Redirigiendo a /agente (Agente de Soporte)");
            window.location.href = "/agente";
          } else {
            console.log("‚ö†Ô∏è id_rol no reconocido, redirigiendo a /home por defecto");
            window.location.href = "/home";
          }

        } catch (error) {
          console.error("Error de login:", error);
          errorMessageDiv.textContent = error.message;
          errorMessageDiv.style.display = "block";
        }
      });
    });
  </script>
</body>

</html>