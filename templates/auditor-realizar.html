<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Auditor√≠a - Royal Crumbs</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/auditor.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos espec√≠ficos para el checklist */
        .audit-form {
            margin-top: 20px;
        }

        .section-title {
            background: linear-gradient(135deg, #ab925c 0%, #c9a86a 100%);
            color: #fff;
            padding: clamp(12px, 2.5vw, 16px);
            margin: clamp(20px, 4vw, 30px) 0 clamp(12px, 2.5vw, 16px);
            border-radius: 8px;
            font-size: clamp(18px, 4vw, 22px);
            font-weight: 700;
            text-align: center;
        }

        .question-block {
            background-color: #181818;
            border-radius: 10px;
            padding: clamp(14px, 3vw, 18px);
            margin-bottom: clamp(12px, 2.5vw, 16px);
            border-left: 4px solid #ab925c;
        }

        .question-title {
            font-size: clamp(14px, 3vw, 16px);
            font-weight: 600;
            color: #ab925c;
            margin-bottom: 8px;
        }

        .question-text {
            font-size: clamp(13px, 2.8vw, 15px);
            color: #ccc;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: clamp(10px, 2vw, 12px);
            margin-top: 12px;
        }

        .option-label {
            display: inline-flex;
            align-items: center;
            padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2vw, 14px);
            background-color: #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(12px, 2.5vw, 14px);
            color: #ccc;
            border: 2px solid transparent;
        }

        .option-label:hover {
            background-color: #353535;
            border-color: #ab925c;
        }

        .option-label input[type="radio"] {
            margin-right: 6px;
            cursor: pointer;
            accent-color: #ab925c;
        }

        .option-label input[type="radio"]:checked+span {
            color: #ab925c;
            font-weight: 600;
        }

        .btn-container {
            display: flex;
            gap: 12px;
            margin-top: clamp(24px, 4vw, 30px);
            flex-wrap: wrap;
        }

        .btn-generate-pdf {
            flex: 1;
            min-width: 200px;
            background: linear-gradient(135deg, #ab925c 0%, #c9a86a 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: clamp(14px, 3vw, 16px) clamp(20px, 4vw, 24px);
            font-size: clamp(14px, 3vw, 16px);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-generate-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(171, 146, 92, 0.4);
        }

        .btn-reset {
            flex: 1;
            min-width: 200px;
            background-color: #3a3a3a;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: clamp(14px, 3vw, 16px) clamp(20px, 4vw, 24px);
            font-size: clamp(14px, 3vw, 16px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-reset:hover {
            background-color: #4a4a4a;
        }

        @media (max-width: 640px) {
            .options-container {
                flex-direction: column;
            }

            .option-label {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>

    <!-- ======== ENCABEZADO ======== -->
    <div class="rc-header">
        <a href="/auditor" class="rc-back">‚Äπ</a>
        <h1 class="rc-screen-title">Auditor√≠a ISO 14001</h1>
        <div></div>
    </div>

    <!-- ======== CONTENEDOR ======== -->
    <div class="rc-container">

        <form id="audit-form" class="audit-form">
            <div id="contenido"></div>

            <div class="btn-container">
                <button type="button" class="btn-generate-pdf" onclick="generarPDF()">
                    üìÑ Generar PDF
                </button>
                <button type="button" class="btn-reset" onclick="resetForm()">
                    üîÑ Limpiar Formulario
                </button>
            </div>
        </form>

    </div>

    <script>
        // Funci√≥n para generar opciones de respuesta
        function opciones(nombre) {
            return `
        <div class="options-container">
          <label class="option-label">
            <input type="radio" name="${nombre}" value="Cumple">
            <span>‚úÖ Cumple</span>
          </label>
          <label class="option-label">
            <input type="radio" name="${nombre}" value="No Cumple">
            <span>‚ùå No Cumple</span>
          </label>
          <label class="option-label">
            <input type="radio" name="${nombre}" value="Cumple Parcialmente">
            <span>‚ö†Ô∏è Cumple Parcialmente</span>
          </label>
          <label class="option-label">
            <input type="radio" name="${nombre}" value="No Aplica">
            <span>‚ûñ No Aplica</span>
          </label>
        </div>
      `;
        }

        // Datos de auditor√≠a ISO 14001
        var datosAuditoria = [
            { type: "titulo", texto: "4. CONTEXTO DE LA ORGANIZACI√ìN" },
            {
                type: "grid", titulo: "4.1 Comprensi√≥n de la organizaci√≥n y su contexto", filas: [
                    "¬øSe tienen identificadas las cuestiones internas y externas asociadas con las necesidades de la empresa?"
                ]
            },
            {
                type: "grid", titulo: "4.2 Comprensi√≥n de las necesidades y expectativas de las partes interesadas", filas: [
                    "¬øSe dispone de la correcta metodolog√≠a para la identificaci√≥n inicial de las partes interesadas?"
                ]
            },
            {
                type: "grid", titulo: "4.3 Determinaci√≥n del alcance del SGA", filas: [
                    "¬øEl alcance del SGA es acorde a las metas y objetivos propuestos?"
                ]
            },
            {
                type: "grid", titulo: "4.4 SGA", filas: [
                    "¬øEl SGA inter-relaciona todos los procesos necesarios?"
                ]
            },

            { type: "titulo", texto: "5. LIDERAZGO" },
            {
                type: "grid", titulo: "5.1 Liderazgo y compromiso", filas: [
                    "¬øLa alta direcci√≥n est√° comprometida con el SGA?",
                    "¬øLos objetivos planteados son acordes a las necesidades?",
                    "¬øFacilita los recursos necesarios para implementar el SGA?",
                    "¬øSe dirige y apoya a los trabajadores para lograr mejora continua?"
                ]
            },
            {
                type: "grid", titulo: "5.2 Pol√≠tica Ambiental", filas: [
                    "¬øLa empresa tiene establecida una pol√≠tica ambiental?",
                    "¬øLa pol√≠tica tiene soporte te√≥rico para los objetivos?",
                    "¬øLa pol√≠tica genera compromisos en los empleados?"
                ]
            },
            {
                type: "grid", titulo: "5.3 Roles, responsabilidades y autoridades", filas: [
                    "¬øLa alta direcci√≥n ha generado canales efectivos de comunicaci√≥n?"
                ]
            },

            { type: "titulo", texto: "6. PLANIFICACI√ìN" },
            {
                type: "grid", titulo: "6.1.1 Requisitos Generales", filas: [
                    "¬øLa empresa ha generado indicadores ambientales?",
                    "¬øHa identificado riesgos y oportunidades?",
                    "¬øCuenta con documentaci√≥n organizada por procesos?",
                    "¬øTiene identificadas situaciones de incidentes y accidentes?",
                    "¬øCuenta con documentaci√≥n del alcance del SGA?"
                ]
            },
            {
                type: "grid", titulo: "6.1.2 Aspectos Ambientales", filas: [
                    "¬øCuenta con metodolog√≠a para identificar aspectos ambientales?",
                    "¬øHa implementado acciones preventivas y correctivas?",
                    "¬øLa identificaci√≥n de aspectos se comunic√≥ en todos los niveles?",
                    "¬øLa informaci√≥n documentada permite clasificar impactos?"
                ]
            },
            {
                type: "grid", titulo: "6.1.3 Requisitos legales y otros requisitos", filas: [
                    "¬øLa organizaci√≥n ha identificado sus obligaciones ambientales?",
                    "¬øCuenta con procedimientos para requisitos legales?",
                    "¬øLa informaci√≥n est√° ordenada y clasificada?"
                ]
            },
            {
                type: "grid", titulo: "6.1.4 Planificaci√≥n de acciones", filas: [
                    "¬øCuenta con un plan de acci√≥n para cumplir metas ambientales?"
                ]
            },

            { type: "titulo", texto: "7. APOYO" },
            {
                type: "grid", titulo: "7.1 Recursos", filas: [
                    "¬øLa empresa facilita los recursos suficientes?"
                ]
            },
            {
                type: "grid", titulo: "7.2 Competencia", filas: [
                    "¬øCuenta con personal competente?",
                    "¬øExiste informaci√≥n documentada de competencias?",
                    "¬øSe eval√∫a la eficacia de las competencias?"
                ]
            },
            {
                type: "grid", titulo: "7.3 Toma de conciencia", filas: [
                    "¬øTodo el personal conoce pol√≠tica, objetivos y su rol?",
                    "¬øSe identifican necesidades de formaci√≥n?",
                    "¬øExisten procedimientos para generar conciencia ambiental?"
                ]
            },
            {
                type: "grid", titulo: "7.4.1 Comunicaci√≥n general", filas: [
                    "¬øLos procesos de comunicaci√≥n son efectivos?"
                ]
            },
            {
                type: "grid", titulo: "7.4.2 Comunicaci√≥n interna", filas: [
                    "¬øHay recepci√≥n, documentaci√≥n y respuesta de comunicaciones externas?"
                ]
            },
            {
                type: "grid", titulo: "7.4.3 Comunicaci√≥n externa", filas: [
                    "¬øExisten procedimientos de comunicaci√≥n interna?"
                ]
            },
            {
                type: "grid", titulo: "7.5 Informaci√≥n Documentada", filas: [
                    "¬øSe describen los elementos del SGA y su interacci√≥n?",
                    "¬øSe describe el alcance del SGA?",
                    "¬øLos documentos est√°n aprobados y revisados seg√∫n la norma?"
                ]
            },
            {
                type: "grid", titulo: "7.5.2 Creaci√≥n y actualizaci√≥n de documentos", filas: [
                    "¬øSe cuenta con documentos de control requeridos?"
                ]
            },
            {
                type: "grid", titulo: "7.5.3 Control de informaci√≥n documentada", filas: [
                    "¬øLa informaci√≥n est√° disponible, protegida y almacenada adecuadamente?"
                ]
            },

            { type: "titulo", texto: "8. OPERACI√ìN" },
            {
                type: "grid", titulo: "8.1 Planificaci√≥n y control operacional", filas: [
                    "¬øHay control de requisitos ambientales del ciclo de vida?",
                    "¬øExisten procedimientos para controlar impactos ambientales?"
                ]
            },
            {
                type: "grid", titulo: "8.2 Preparaci√≥n y respuesta a emergencias", filas: [
                    "¬øSe identifican situaciones potenciales de emergencia?",
                    "¬øSe revisan y modifican procedimientos?",
                    "¬øSe realizan pruebas peri√≥dicas?",
                    "¬øExiste evidencia documentada?"
                ]
            },

            { type: "titulo", texto: "9. EVALUACI√ìN DEL DESEMPE√ëO" },
            {
                type: "grid", titulo: "9. Medici√≥n del desempe√±o", filas: [
                    "¬øExisten procedimientos para medir impactos ambientales?"
                ]
            },
            {
                type: "grid", titulo: "9.1.1 General", filas: [
                    "¬øEst√° identificado lo que se monitorea?",
                    "¬øHay registros de calibraci√≥n?",
                    "¬øHay informaci√≥n documentada sobre mediciones?"
                ]
            },
            {
                type: "grid", titulo: "9.1.2 Evaluaci√≥n de cumplimiento", filas: [
                    "¬øSe eval√∫a cumplimiento legal peri√≥dicamente?",
                    "¬øHay registros de evaluaciones?",
                    "¬øLa evaluaci√≥n ayuda a tomar decisiones ambientales?"
                ]
            },
            {
                type: "grid", titulo: "9.2.2 Auditor√≠a interna", filas: [
                    "¬øSe realizan auditor√≠as internas peri√≥dicas?",
                    "¬øHay programa de auditor√≠as basado en importancia ambiental?"
                ]
            },
            {
                type: "grid", titulo: "9.3 Revisi√≥n por la direcci√≥n", filas: [
                    "¬øLa revisi√≥n del SGA est√° planificada?",
                    "¬øLa evaluaci√≥n de auditor√≠as es √∫til para la mejora continua?",
                    "¬øExiste evidencia documentada?"
                ]
            },

            { type: "titulo", texto: "10. MEJORA" },
            {
                type: "grid", titulo: "10. Mejora", filas: [
                    "¬øSe han implementado acciones de mejora?",
                    "¬øHay procedimientos para tratar no conformidades?",
                    "¬øLa empresa mejora procesos seg√∫n sus falencias?"
                ]
            }
        ];

        // Generar HTML del checklist
        var cont = document.getElementById("contenido");
        var index = 0;
        var questions = []; // Para guardar las preguntas y respuestas

        datosAuditoria.forEach(item => {
            if (item.type === "titulo") {
                cont.innerHTML += `<h2 class="section-title">${item.texto}</h2>`;
            }

            if (item.type === "grid") {
                item.filas.forEach(fila => {
                    index++;
                    const questionId = "p" + index;

                    // Guardar pregunta para el PDF
                    questions.push({
                        id: questionId,
                        seccion: item.titulo,
                        pregunta: fila
                    });

                    cont.innerHTML += `
            <div class="question-block">
              <div class="question-title">${item.titulo}</div>
              <div class="question-text">${fila}</div>
              ${opciones(questionId)}
            </div>
          `;
                });
            }
        });

        // Funci√≥n para generar PDF
        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header del PDF
            doc.setFontSize(18);
            doc.setTextColor(171, 146, 92); // Dorado
            doc.text("Auditor√≠a ISO 14001", 105, 20, { align: "center" });

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Royal Crumbs Casino", 105, 28, { align: "center" });
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 105, 34, { align: "center" });

            let y = 45;
            let cumple = 0, noCumple = 0, parcial = 0, noAplica = 0, sinResponder = 0;

            doc.setFontSize(12);
            doc.setTextColor(0);

            questions.forEach((q, i) => {
                // Verificar si necesitamos una nueva p√°gina
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                // Obtener respuesta seleccionada
                const radios = document.getElementsByName(q.id);
                let respuesta = "Sin responder";
                radios.forEach(radio => {
                    if (radio.checked) {
                        respuesta = radio.value;
                    }
                });

                // Contar respuestas
                if (respuesta === "Cumple") cumple++;
                else if (respuesta === "No Cumple") noCumple++;
                else if (respuesta === "Cumple Parcialmente") parcial++;
                else if (respuesta === "No Aplica") noAplica++;
                else sinResponder++;

                // Pregunta
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text(`${i + 1}. ${q.seccion}`, 15, y);
                y += 5;

                doc.setFont(undefined, 'normal');
                const splitText = doc.splitTextToSize(q.pregunta, 180);
                doc.text(splitText, 15, y);
                y += (splitText.length * 5);

                // Respuesta
                doc.setFont(undefined, 'bold');
                if (respuesta === "Cumple") doc.setTextColor(0, 150, 0);
                else if (respuesta === "No Cumple") doc.setTextColor(200, 0, 0);
                else if (respuesta === "Cumple Parcialmente") doc.setTextColor(200, 150, 0);
                else doc.setTextColor(100);

                doc.text(`Respuesta: ${respuesta}`, 15, y);
                doc.setTextColor(0);
                y += 8;
            });

            // Agregar p√°gina de resumen
            doc.addPage();
            doc.setFontSize(16);
            doc.setTextColor(171, 146, 92);
            doc.text("Resumen de Resultados", 105, 20, { align: "center" });

            y = 40;
            doc.setFontSize(12);
            doc.setTextColor(0);

            doc.setTextColor(0, 150, 0);
            doc.text(`‚úì Cumple: ${cumple}`, 40, y);
            y += 10;

            doc.setTextColor(200, 0, 0);
            doc.text(`‚úó No Cumple: ${noCumple}`, 40, y);
            y += 10;

            doc.setTextColor(200, 150, 0);
            doc.text(`‚ö† Cumple Parcialmente: ${parcial}`, 40, y);
            y += 10;

            doc.setTextColor(100);
            doc.text(`‚àí No Aplica: ${noAplica}`, 40, y);
            y += 10;

            doc.text(`? Sin Responder: ${sinResponder}`, 40, y);
            y += 15;

            // Porcentaje de cumplimiento
            const totalRespondidas = cumple + noCumple + parcial;
            const porcentajeCumplimiento = totalRespondidas > 0 ?
                Math.round(((cumple + (parcial * 0.5)) / totalRespondidas) * 100) : 0;

            doc.setFontSize(14);
            doc.setTextColor(171, 146, 92);
            doc.text(`Cumplimiento Total: ${porcentajeCumplimiento}%`, 40, y);

            // --- INICIO: GUARDAR AUDITOR√çA EN EL BACKEND ---
            // Usamos una funci√≥n as√≠ncrona para no bloquear la generaci√≥n del PDF
            const guardarAuditoria = async () => {
                // Asumimos que el ID del auditor est√° en localStorage (se guarda en el login)
                const idAuditor = localStorage.getItem("user_id");
                if (!idAuditor) {
                    console.error("No se encontr√≥ el ID del auditor. No se puede guardar.");
                    return; // No continuar si no hay ID
                }

                const auditData = {
                    id_auditor: parseInt(idAuditor),
                    fecha: new Date().toISOString(),
                    cumple: cumple,
                    no_cumple: noCumple,
                    parcial: parcial,
                    no_aplica: noAplica,
                    porcentaje_cumplimiento: porcentajeCumplimiento
                };

                try {
                    // Este es el endpoint que debes crear en tu backend (FastAPI)
                    await fetch('/api/auditor/guardar-auditoria', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(auditData)
                    });
                } catch (error) {
                    console.error("Error al guardar la auditor√≠a:", error);
                    // Opcional: podr√≠as notificar al usuario que el guardado fall√≥
                }
            };

            guardarAuditoria();
            // --- FIN: GUARDAR AUDITOR√çA EN EL BACKEND ---

            // Guardar PDF
            const fecha = new Date().toISOString().split('T')[0];
            doc.save(`Auditoria_ISO14001_${fecha}.pdf`);

            alert("‚úÖ PDF generado y auditor√≠a guardada exitosamente.");
        }

        // Funci√≥n para limpiar formulario
        function resetForm() {
            if (confirm("¬øEst√°s seguro de que deseas limpiar todas las respuestas?")) {
                document.getElementById("audit-form").reset();
                alert("‚úÖ Formulario limpiado");
            }
        }
    </script>

</body>

</html>