<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionar perfil de Administrador — Royal Crumbs</title>
  <link rel="stylesheet" href="{{ url_for('static', path='css/admin-administrador-perfil.css') }}">
  <script src="{{ url_for('static', path='js/admin-auth.js') }}"></script>
</head>

<body>
  <div class="rc-container">

    <!-- ===== ENCABEZADO 3 ===== -->
    <header class="rc-header">
      <a href="/admin/administradores" class="rc-back">‹</a>
      <h1 class="rc-screen-title">Gestionar perfil de Administrador</h1>
      <div></div>
    </header>

    <!-- ===== FORMULARIO ===== -->
    <form class="admin-form" id="adminForm">
      <select id="rol" required>
        <option value="" disabled>Rol</option>
        <option value="Administrador">Administrador</option>
        <option value="Auditor">Auditor</option>
      </select>

      <input type="text" id="nombre" placeholder="Nombre(s)" required>
      <input type="text" id="apellido" placeholder="Apellido(s)" required>
      <input type="email" id="email" placeholder="Correo" required>
    </form>

    <!-- ===== CONFIGURACIÓN DE CUENTA ===== -->
    <section class="account-config">
      <h2>Configuración de Cuenta</h2>
      <div class="password-reset">
        <p>Restablecer Contraseña</p>
        <a href="#" class="rc-chevron" id="resetPasswordBtn"></a>
      </div>

      <div class="status-buttons">
        <button class="status-btn active" data-status="true">Activa</button>
        <button class="status-btn suspended" data-status="false">Suspendida</button>
      </div>
    </section>

    <!-- ===== BOTONES ===== -->
    <div class="action-buttons">
      <button class="save-btn" id="saveBtn">Guardar Cambios</button>
      <button class="delete-btn" id="deleteBtn">Eliminar Cuenta</button>
    </div>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Verificar autenticación
      if (!checkAdminAuth()) {
        return;
      }

      // Obtener ID del administrador de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const adminId = urlParams.get('id');

      if (!adminId) {
        alert("No se especificó un ID de administrador");
        window.location.href = "/admin/administradores";
        return;
      }

      // Elementos del formulario
      const nombreInput = document.getElementById('nombre');
      const apellidoInput = document.getElementById('apellido');
      const emailInput = document.getElementById('email');
      const rolSelect = document.getElementById('rol');
      const statusButtons = document.querySelectorAll('.status-btn');
      const saveBtn = document.getElementById('saveBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const resetPasswordBtn = document.getElementById('resetPasswordBtn');

      let currentStatus = true;

      // Cargar datos del administrador
      try {
        const response = await fetch(`/api/admin/user-profile/${adminId}`);
        const data = await response.json();

        if (data.error) {
          alert("Error al cargar el perfil: " + data.error);
          window.location.href = "/admin/administradores";
          return;
        }

        // Llenar el formulario
        nombreInput.value = data.nombre || '';
        apellidoInput.value = data.apellido || '';
        emailInput.value = data.email || '';
        rolSelect.value = data.rol || 'Administrador';
        currentStatus = data.activo;

        // Actualizar botones de estado
        statusButtons.forEach(btn => {
          const btnStatus = btn.getAttribute('data-status') === 'true';
          if (btnStatus === currentStatus) {
            btn.classList.add('selected');
          }
        });

      } catch (error) {
        console.error("Error al cargar perfil:", error);
        alert("Error al cargar el perfil del administrador");
      }

      // Manejar cambio de estado
      statusButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          statusButtons.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          currentStatus = btn.getAttribute('data-status') === 'true';
        });
      });

      // Guardar cambios
      saveBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        const formData = new FormData();
        formData.append('nombre', nombreInput.value);
        formData.append('apellido', apellidoInput.value);
        formData.append('email', emailInput.value);
        formData.append('rol', rolSelect.value);
        formData.append('activo', currentStatus);

        try {
          const response = await fetch(`/api/admin/user-profile/${adminId}`, {
            method: 'PUT',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            alert("Perfil actualizado exitosamente");
            window.location.href = "/admin/administradores";
          } else {
            alert("Error: " + (result.error || "No se pudo actualizar"));
          }
        } catch (error) {
          console.error("Error al guardar:", error);
          alert("Error al guardar los cambios");
        }
      });

      // Eliminar cuenta
      deleteBtn.addEventListener('click', () => {
        if (confirm("¿Estás seguro de que deseas eliminar esta cuenta? Esta acción no se puede deshacer.")) {
          alert("Funcionalidad de eliminación pendiente de implementar");
        }
      });

      // Restablecer contraseña
      resetPasswordBtn.addEventListener('click', (e) => {
        e.preventDefault();
        alert("Funcionalidad de restablecimiento de contraseña pendiente de implementar");
      });
    });
  </script>
</body>

</html>